<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <title>RassterAuth</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        box-sizing: border-box;
      }
    </style>
  </head>
  <body class="h-full bg-slate-900 text-slate-100">
    <div id="app" class="w-full h-full overflow-auto"></div>

    <script>
      // =========================
      // CONFIG
      // =========================
      const API_BASE = "YOUR_APPS_SCRIPT_URL_HERE"; // <-- your Apps Script URL

      // =========================
      // SIMPLE STATE
      // =========================
      let view = "welcome"; // 'welcome' | 'auth' | 'admin' | 'reseller'
      let authMode = "login"; // 'login' | 'register'
      let currentUser = null;
      let usersCache = []; // used in admin dashboard

      // =========================
      // RENDERING
      // =========================
      function render() {
        const app = document.getElementById("app");
        if (view === "welcome") {
          app.innerHTML = renderWelcome();
        } else if (view === "auth") {
          app.innerHTML = renderAuth();
        } else if (view === "admin") {
          app.innerHTML = renderAdmin();
        } else if (view === "reseller") {
          app.innerHTML = renderReseller();
        }
        attachEvents();
      }

      function renderWelcome() {
        return `
        <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
          <div class="max-w-2xl w-full px-6 py-10 bg-slate-900/70 backdrop-blur-lg rounded-3xl shadow-2xl border border-slate-700">
            <div class="flex flex-col items-center gap-4">
              <div class="inline-flex items-center gap-3 px-3 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/40 text-emerald-300 text-xs font-medium">
                <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
                Secure Licensing Panel
              </div>
              <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-center">
                Rasster<span class="text-emerald-400">Auth</span>
              </h1>
              <p class="text-slate-300 text-center max-w-xl">
                Centralized license and client management for your products.
                Admin approves resellers, resellers manage their own clients and keys.
              </p>
              <div class="mt-6 flex flex-col sm:flex-row gap-3">
                <button id="enterBtn"
                  class="px-8 py-3 rounded-full text-sm font-semibold bg-emerald-500 hover:bg-emerald-400 text-slate-900 shadow-lg shadow-emerald-500/30 transition">
                  Enter Panel
                </button>
                <button id="learnBtn"
                  class="px-6 py-3 rounded-full text-sm font-semibold border border-slate-600 hover:border-slate-400 text-slate-200">
                  Learn More
                </button>
              </div>
              <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-4 text-xs text-slate-300 w-full">
                <div class="p-3 rounded-xl bg-slate-800/60 border border-slate-700">
                  <p class="font-semibold mb-1">Admin Approval</p>
                  <p>New resellers must be approved before accessing the panel.</p>
                </div>
                <div class="p-3 rounded-xl bg-slate-800/60 border border-slate-700">
                  <p class="font-semibold mb-1">Email Verification</p>
                  <p>Gmail verification with secure Brevo API integration.</p>
                </div>
                <div class="p-3 rounded-xl bg-slate-800/60 border border-slate-700">
                  <p class="font-semibold mb-1">Google Sheets</p>
                  <p>All users are stored in your RassterAuth Google Sheet.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      }

      function renderAuth() {
        const isLogin = authMode === "login";

        return `
        <div class="min-h-screen flex items-center justify-center bg-slate-900">
          <div class="w-full max-w-4xl mx-4 grid md:grid-cols-2 gap-6">
            <!-- Left side branding -->
            <div class="hidden md:flex flex-col justify-between rounded-3xl p-8 bg-gradient-to-br from-emerald-500 via-emerald-400 to-sky-500 shadow-2xl">
              <div>
                <h1 class="text-3xl font-extrabold tracking-tight text-slate-900">
                  RassterAuth
                </h1>
                <p class="mt-2 text-sm text-slate-900/80">
                  Central panel for Admin and Resellers.
                </p>
              </div>
              <div class="mt-6 space-y-3 text-sm text-slate-900">
                <p>➤ Admin Login: <b>Admin / Admin</b></p>
                <p>➤ New resellers must verify Gmail and then wait for admin approval.</p>
                <p>➤ After approval, they can log in and access the Rasster reseller panel.</p>
              </div>
              <div class="mt-6 text-xs text-slate-900/80">
                Connected to Google Sheets:
                <span class="font-mono break-all">1KBtZvvgRuW5n3fDfavOy-GepsX1HLR2PFzjFwDmwYO0</span>
              </div>
            </div>

            <!-- Right side auth card -->
            <div class="bg-slate-900/80 border border-slate-700 rounded-3xl p-8 shadow-xl">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-100">
                  ${isLogin ? "Sign in to RassterAuth" : "Create RassterAuth Account"}
                </h2>
                <button id="backToWelcomeBtn" class="text-xs text-slate-400 hover:text-slate-200">
                  ← Back
                </button>
              </div>

              <div class="mb-4 flex text-sm bg-slate-800 rounded-full p-1">
                <button id="tabLogin"
                  class="flex-1 py-2 rounded-full ${
                    isLogin ? "bg-slate-900 text-slate-100" : "text-slate-400"
                  }">
                  Login
                </button>
                <button id="tabRegister"
                  class="flex-1 py-2 rounded-full ${
                    !isLogin ? "bg-slate-900 text-slate-100" : "text-slate-400"
                  }">
                  Register
                </button>
              </div>

              ${
                isLogin
                  ? renderLoginForm()
                  : renderRegisterForm()
              }
            </div>
          </div>
        </div>
      `;
      }

      function renderLoginForm() {
        return `
        <form id="loginForm" class="space-y-4">
          <div>
            <label class="block text-sm mb-1">Username</label>
            <input id="loginUsername" type="text" required
              class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          </div>
          <div>
            <label class="block text-sm mb-1">Password</label>
            <input id="loginPassword" type="password" required
              class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          </div>
          <div id="loginError" class="hidden text-xs px-3 py-2 rounded bg-red-500/10 text-red-300"></div>
          <button id="loginBtn" type="submit"
            class="w-full py-2.5 rounded-lg text-sm font-semibold bg-emerald-500 hover:bg-emerald-400 text-slate-900">
            Sign In
          </button>
        </form>
      `;
      }

      function renderRegisterForm() {
        return `
        <form id="registerForm" class="space-y-4">
          <div>
            <label class="block text-sm mb-1">Gmail Address</label>
            <input id="registerEmail" type="email" required
              class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
              placeholder="yourname@gmail.com" />
          </div>
          <div>
            <label class="block text-sm mb-1">Username</label>
            <input id="registerUsername" type="text" required
              class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          </div>
          <div>
            <label class="block text-sm mb-1">Password</label>
            <input id="registerPassword" type="password" required
              class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          </div>
          <div id="registerError" class="hidden text-xs px-3 py-2 rounded bg-red-500/10 text-red-300"></div>
          <div id="registerSuccess" class="hidden text-xs px-3 py-2 rounded bg-emerald-500/10 text-emerald-300"></div>
          <button id="registerBtn" type="submit"
            class="w-full py-2.5 rounded-lg text-sm font-semibold bg-emerald-500 hover:bg-emerald-400 text-slate-900">
            Register & Verify Email
          </button>
        </form>
      `;
      }

      function renderAdmin() {
        const pending = usersCache.filter(
          (u) => u.role === "reseller" && u.emailVerified && u.status !== "approved"
        );
        const allResellers = usersCache.filter((u) => u.role === "reseller");

        return `
        <div class="min-h-screen flex bg-slate-900 text-slate-100">
          <!-- Sidebar -->
          <aside class="w-64 bg-slate-950 border-r border-slate-800 flex flex-col">
            <div class="px-4 py-4 border-b border-slate-800">
              <div class="text-lg font-bold tracking-tight">
                Rasster<span class="text-emerald-400">Auth</span>
              </div>
              <div class="text-xs text-slate-400 mt-1">Admin Panel</div>
            </div>
            <nav class="flex-1 px-3 py-4 space-y-1 text-sm">
              <div class="px-3 py-2 rounded-lg bg-slate-800 text-emerald-300 font-medium flex items-center justify-between">
                <span>Dashboard</span>
                <span class="text-[10px] bg-emerald-500/20 text-emerald-300 px-2 py-0.5 rounded-full">ADMIN</span>
              </div>
              <div class="px-3 py-2 rounded-lg hover:bg-slate-800 cursor-default text-slate-300">
                Resellers
              </div>
              <div class="px-3 py-2 rounded-lg hover:bg-slate-800 cursor-default text-slate-300">
                Settings
              </div>
            </nav>
            <div class="px-4 py-4 border-t border-slate-800 text-xs text-slate-400 flex justify-between items-center">
              <span>Logged in as <b>Admin</b></span>
              <button id="logoutBtn" class="text-red-400 hover:text-red-300">Logout</button>
            </div>
          </aside>

          <!-- Main -->
          <main class="flex-1 p-6 space-y-6">
            <div class="flex flex-wrap gap-4">
              <div class="flex-1 min-w-[180px] p-4 rounded-2xl bg-slate-800 border border-slate-700">
                <div class="text-xs text-slate-400">Pending approvals</div>
                <div class="mt-1 text-2xl font-bold">${pending.length}</div>
              </div>
              <div class="flex-1 min-w-[180px] p-4 rounded-2xl bg-slate-800 border border-slate-700">
                <div class="text-xs text-slate-400">Total resellers</div>
                <div class="mt-1 text-2xl font-bold">${allResellers.length}</div>
              </div>
            </div>

            <section class="bg-slate-900/80 border border-slate-700 rounded-2xl p-5">
              <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-semibold">Pending verified resellers</h2>
                <button id="refreshUsersBtn"
                  class="text-xs px-3 py-1 rounded-full border border-slate-600 hover:border-emerald-400">
                  Refresh
                </button>
              </div>
              ${
                pending.length === 0
                  ? `<p class="text-sm text-slate-400">No verified users waiting for approval.</p>`
                  : `
                <div class="overflow-x-auto text-sm">
                  <table class="min-w-full border border-slate-700 rounded-lg overflow-hidden">
                    <thead class="bg-slate-800 text-slate-300">
                      <tr>
                        <th class="px-3 py-2 text-left">Username</th>
                        <th class="px-3 py-2 text-left">Email</th>
                        <th class="px-3 py-2 text-left">Status</th>
                        <th class="px-3 py-2 text-left">Action</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-800">
                      ${pending
                        .map(
                          (u) => `
                        <tr>
                          <td class="px-3 py-2">${u.username}</td>
                          <td class="px-3 py-2">${u.email}</td>
                          <td class="px-3 py-2">
                            <span class="text-xs px-2 py-0.5 rounded-full bg-yellow-500/10 text-yellow-300">
                              ${u.status}
                            </span>
                          </td>
                          <td class="px-3 py-2">
                            <button class="approveBtn text-xs px-3 py-1 rounded-full bg-emerald-500 hover:bg-emerald-400 text-slate-900"
                              data-user-id="${u.id}">
                              Approve
                            </button>
                          </td>
                        </tr>
                      `
                        )
                        .join("")}
                    </tbody>
                  </table>
                </div>
              `
              }
            </section>

            <section class="bg-slate-900/80 border border-slate-700 rounded-2xl p-5">
              <h2 class="text-lg font-semibold mb-3">All resellers</h2>
              ${
                allResellers.length === 0
                  ? `<p class="text-sm text-slate-400">No resellers yet.</p>`
                  : `
                <div class="overflow-x-auto text-sm">
                  <table class="min-w-full border border-slate-700 rounded-lg overflow-hidden">
                    <thead class="bg-slate-800 text-slate-300">
                      <tr>
                        <th class="px-3 py-2 text-left">Username</th>
                        <th class="px-3 py-2 text-left">Email</th>
                        <th class="px-3 py-2 text-left">Email Verified</th>
                        <th class="px-3 py-2 text-left">Status</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-800">
                      ${allResellers
                        .map(
                          (u) => `
                        <tr>
                          <td class="px-3 py-2">${u.username}</td>
                          <td class="px-3 py-2">${u.email}</td>
                          <td class="px-3 py-2">
                            ${
                              u.emailVerified
                                ? '<span class="text-xs px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-300">Yes</span>'
                                : '<span class="text-xs px-2 py-0.5 rounded-full bg-red-500/10 text-red-300">No</span>'
                            }
                          </td>
                          <td class="px-3 py-2 text-xs">
                            ${
                              u.status === "approved"
                                ? '<span class="px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-300">approved</span>'
                                : `<span class="px-2 py-0.5 rounded-full bg-yellow-500/10 text-yellow-300">${u.status}</span>`
                            }
                          </td>
                        </tr>
                      `
                        )
                        .join("")}
                    </tbody>
                  </table>
                </div>
              `
              }
            </section>
          </main>
        </div>
      `;
      }

      function renderReseller() {
        return `
        <div class="min-h-screen flex bg-slate-900 text-slate-100">
          <!-- Sidebar -->
          <aside class="w-64 bg-slate-950 border-r border-slate-800 flex flex-col">
            <div class="px-4 py-4 border-b border-slate-800">
              <div class="text-lg font-bold tracking-tight">
                <span class="text-emerald-400">RASTER</span>
              </div>
              <div class="text-xs text-slate-400 mt-1">Reseller Panel</div>
            </div>
            <nav class="flex-1 px-3 py-4 space-y-1 text-sm">
              <div class="px-3 py-2 rounded-lg bg-slate-800 text-emerald-300 font-medium">
                Dashboard
              </div>
              <div class="px-3 py-2 rounded-lg hover:bg-slate-800 cursor-default text-slate-300">
                Licenses
              </div>
              <div class="px-3 py-2 rounded-lg hover:bg-slate-800 cursor-default text-slate-300">
                Clients
              </div>
              <div class="px-3 py-2 rounded-lg hover:bg-slate-800 cursor-default text-slate-300">
                Payments
              </div>
              <div class="px-3 py-2 rounded-lg hover:bg-slate-800 cursor-default text-slate-300">
                Settings
              </div>
            </nav>
            <div class="px-4 py-4 border-t border-slate-800 text-xs text-slate-400 flex justify-between items-center">
              <span>${currentUser?.username}</span>
              <button id="logoutBtn" class="text-red-400 hover:text-red-300">Logout</button>
            </div>
          </aside>

          <!-- Main -->
          <main class="flex-1 p-6 space-y-6">
            <div class="flex flex-wrap gap-4">
              <div class="flex-1 min-w-[180px] p-4 rounded-2xl bg-slate-800 border border-slate-700">
                <div class="text-xs text-slate-400">Welcome</div>
                <div class="mt-1 text-xl font-bold">Hello, ${
                  currentUser?.username
                }</div>
                <div class="mt-1 text-xs text-slate-400">
                  Your account is active as <b>reseller</b>.
                </div>
              </div>
              <div class="flex-1 min-w-[180px] p-4 rounded-2xl bg-slate-800 border border-slate-700">
                <div class="text-xs text-slate-400">Status</div>
                <div class="mt-1 text-xl font-bold text-emerald-400">Approved</div>
                <div class="mt-1 text-xs text-slate-400">
                  You can now manage your clients and licenses.
                </div>
              </div>
            </div>

            <section class="bg-slate-900/80 border border-slate-700 rounded-2xl p-5">
              <h2 class="text-lg font-semibold mb-2">Quick Stats</h2>
              <p class="text-sm text-slate-400 mb-3">
                (Demo only) This is placeholder content – you can add real license and client statistics here.
              </p>
              <div class="grid sm:grid-cols-3 gap-4 text-sm">
                <div class="p-3 rounded-xl bg-slate-800 border border-slate-700">
                  <div class="text-xs text-slate-400">Total licenses</div>
                  <div class="text-xl font-bold mt-1">0</div>
                </div>
                <div class="p-3 rounded-xl bg-slate-800 border border-slate-700">
                  <div class="text-xs text-slate-400">Active clients</div>
                  <div class="text-xl font-bold mt-1">0</div>
                </div>
                <div class="p-3 rounded-xl bg-slate-800 border border-slate-700">
                  <div class="text-xs text-slate-400">Expiring soon</div>
                  <div class="text-xl font-bold mt-1">0</div>
                </div>
              </div>
            </section>
          </main>
        </div>
      `;
      }

      // =========================
      // EVENT HANDLERS
      // =========================
      function attachEvents() {
        const enterBtn = document.getElementById("enterBtn");
        if (enterBtn) {
          enterBtn.addEventListener("click", () => {
            view = "auth";
            authMode = "login";
            render();
          });
        }

        const learnBtn = document.getElementById("learnBtn");
        if (learnBtn) {
          learnBtn.addEventListener("click", () => {
            alert(
              "RassterAuth: Admin approves resellers, email verification via Brevo, users stored in Google Sheets."
            );
          });
        }

        const backToWelcomeBtn = document.getElementById("backToWelcomeBtn");
        if (backToWelcomeBtn) {
          backToWelcomeBtn.addEventListener("click", () => {
            view = "welcome";
            render();
          });
        }

        const tabLogin = document.getElementById("tabLogin");
        if (tabLogin) {
          tabLogin.addEventListener("click", () => {
            authMode = "login";
            render();
          });
        }

        const tabRegister = document.getElementById("tabRegister");
        if (tabRegister) {
          tabRegister.addEventListener("click", () => {
            authMode = "register";
            render();
          });
        }

        const loginForm = document.getElementById("loginForm");
        if (loginForm) {
          loginForm.addEventListener("submit", handleLogin);
        }

        const registerForm = document.getElementById("registerForm");
        if (registerForm) {
          registerForm.addEventListener("submit", handleRegister);
        }

        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", () => {
            currentUser = null;
            view = "auth";
            authMode = "login";
            render();
          });
        }

        const refreshUsersBtn = document.getElementById("refreshUsersBtn");
        if (refreshUsersBtn) {
          refreshUsersBtn.addEventListener("click", () => {
            loadUsersForAdmin();
          });
        }

        const approveBtns = document.querySelectorAll(".approveBtn");
        approveBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            const userId = btn.getAttribute("data-user-id");
            approveUser(userId);
          });
        });
      }

      async function handleLogin(e) {
        e.preventDefault();
        const username = document.getElementById("loginUsername").value.trim();
        const password = document.getElementById("loginPassword").value;
        const errorDiv = document.getElementById("loginError");
        const loginBtn = document.getElementById("loginBtn");

        errorDiv.classList.add("hidden");
        errorDiv.textContent = "";

        // Admin login (front-end only)
        if (username === "Admin" && password === "Admin") {
          currentUser = { username: "Admin", role: "admin" };
          view = "admin";
          await loadUsersForAdmin();
          return;
        }

        loginBtn.disabled = true;
        loginBtn.textContent = "Signing in...";

        try {
          const res = await fetch(API_BASE, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              mode: "login",
              username,
              password,
            }),
          });
          const data = await res.json();

          if (!data.ok) {
            errorDiv.textContent = data.error || "Login failed";
            errorDiv.classList.remove("hidden");
            loginBtn.disabled = false;
            loginBtn.textContent = "Sign In";
            return;
          }

          const user = data.user;

          if (!user.emailVerified) {
            errorDiv.textContent =
              "Please verify your email first (check your Gmail inbox).";
            errorDiv.classList.remove("hidden");
            loginBtn.disabled = false;
            loginBtn.textContent = "Sign In";
            return;
          }

          if (user.status !== "approved") {
            errorDiv.textContent =
              "Your account is waiting for admin approval.";
            errorDiv.classList.remove("hidden");
            loginBtn.disabled = false;
            loginBtn.textContent = "Sign In";
            return;
          }

          currentUser = user;
          view = "reseller";
          render();
        } catch (err) {
          console.error(err);
          errorDiv.textContent = "Network error. Please try again.";
          errorDiv.classList.remove("hidden");
        } finally {
          loginBtn.disabled = false;
          loginBtn.textContent = "Sign In";
        }
      }

      async function handleRegister(e) {
        e.preventDefault();
        const email = document.getElementById("registerEmail").value.trim();
        const username = document
          .getElementById("registerUsername")
          .value.trim();
        const password = document.getElementById("registerPassword").value;
        const errorDiv = document.getElementById("registerError");
        const successDiv = document.getElementById("registerSuccess");
        const registerBtn = document.getElementById("registerBtn");

        errorDiv.classList.add("hidden");
        successDiv.classList.add("hidden");
        errorDiv.textContent = "";
        successDiv.textContent = "";

        if (!email.toLowerCase().endsWith("@gmail.com")) {
          errorDiv.textContent = "Only Gmail addresses are allowed.";
          errorDiv.classList.remove("hidden");
          return;
        }

        registerBtn.disabled = true;
        registerBtn.textContent = "Registering...";

        try {
          const res = await fetch(API_BASE, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              mode: "register",
              email,
              username,
              password,
            }),
          });
          const data = await res.json();

          if (!data.ok) {
            errorDiv.textContent = data.error || "Registration failed.";
            errorDiv.classList.remove("hidden");
          } else {
            successDiv.textContent =
              "Registered successfully! Check your Gmail inbox and click the verification link.";
            successDiv.classList.remove("hidden");
            (document.getElementById("registerForm") || {}).reset?.();
          }
        } catch (err) {
          console.error(err);
          errorDiv.textContent = "Network error. Please try again.";
          errorDiv.classList.remove("hidden");
        } finally {
          registerBtn.disabled = false;
          registerBtn.textContent = "Register & Verify Email";
        }
      }

      async function loadUsersForAdmin() {
        try {
          const res = await fetch(API_BASE + "?mode=listUsers");
          const data = await res.json();
          if (data.ok) {
            usersCache = data.users || [];
            render();
          } else {
            alert("Failed to load users.");
          }
        } catch (err) {
          console.error(err);
          alert("Network error while loading users.");
        }
      }

      async function approveUser(userId) {
        if (!confirm("Approve this reseller?")) return;
        try {
          const res = await fetch(API_BASE, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              mode: "approve",
              userId,
            }),
          });
          const data = await res.json();
          if (data.ok) {
            await loadUsersForAdmin();
          } else {
            alert(data.error || "Approval failed.");
          }
        } catch (err) {
          console.error(err);
          alert("Network error while approving user.");
        }
      }

      // =========================
      // INIT
      // =========================
      render();
    </script>
  </body>
</html>
